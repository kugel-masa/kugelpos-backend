# マルチパターン性能テスト分析レポート

**テスト日時:** 2025-10-21 03:04-03:49
**テスト場所:** `results_backup/20251021_030417/`
**テストパターン:** 20、30、40、50 同時接続ユーザー
**テスト期間:** 各パターン10分間

## エグゼクティブサマリー

カートサービスの性能を評価するため、同時接続ユーザー数を増加させた4つの負荷テストパターンを実施しました。20、30、40同時接続ユーザーのテストは正常に完了し、予測可能な性能劣化を伴う安定した動作を確認しました。しかし、50ユーザーテストは**カートサービスがUNREACHABLEとなり中断**されました。これは、システムが40～50同時接続ユーザーの間で容量限界に達したことを示しています。

### 主要な発見事項

1. **システム容量限界:** 40～50同時接続ユーザー
2. **スループット劣化:** 20→40ユーザーで-71.3% (5.39 → 7.30 req/s)
3. **応答時間劣化:** 中央値が47.7%増加 (44ms → 65ms)
4. **非常に高い変動性:** CV値が109～171%、応答時間の予測不可能性が高い
5. **リクエスト失敗なし:** 完了したテスト全てで0%の失敗率（容量内）
6. **重大な問題:** 50同時接続ユーザーでサービス到達不能

### クイック統計サマリー - アイテム登録操作

| ユーザー数 | リクエスト数 | 中央値 (ms) | 平均 (ms) | 標準偏差 (ms) | CV (%) | p95 (ms) |
|-------|----------|-------------|----------|--------------|--------|----------|
| 20 | 2,934 | 42 | 83.8 | 96.1 | 114.7% | 200 |
| 30 | 2,244 | 47 | 107.8 | 184.2 | 170.9% | 350 |
| 40 | 859 | 59 | 88.0 | 116.1 | 131.9% | 250 |
| 50* | 950 | 61 | 87.8 | 96.1 | 109.4% | 220 |

*サービス障害によりテスト中断

---

## 詳細性能分析

### 1. スループット性能

| 指標 | 20ユーザー | 30ユーザー | 40ユーザー | 50ユーザー* |
|--------|----------|----------|----------|-----------|
| **総リクエスト数** | 3,229 | 2,470 | 920 | 1,007 |
| **リクエスト/秒** | 5.39 | 4.12 | 7.30 | 15.51 |
| **アイテム登録/秒** | 4.90 | 3.74 | 6.81 | 14.63 |
| **カート作成/秒** | 0.26 | 0.21 | 0.36 | 0.77 |
| **カートキャンセル/秒** | 0.23 | 0.17 | 0.13 | 0.11 |

*50ユーザーテストは中断 - データはサービス障害前の部分的な結果

#### スループット分析
- **異常検出:** 40ユーザーテストが30ユーザーテスト（4.12 req/s）より高いスループット（7.30 req/s）を示す
- **20-30ユーザー:** 23.6%のスループット減少（予想される劣化）
- **30-40ユーザー:** 77.2%のスループット増加（予想外 - 早期終了の可能性）
- **40-50ユーザー:** 有意な比較前にサービスクラッシュ

### 2. 応答時間分析

#### 集約応答時間 (ms)

| 指標 | 20ユーザー | 30ユーザー | 40ユーザー | 50ユーザー* |
|--------|----------|----------|----------|-----------|
| **中央値 (50%)** | 44 | 50 | 61 | 65 |
| **平均** | 119.4 | 169.4 | 131.3 | 112.5 |
| **最小** | 33.4 | 34.2 | 33.8 | 33.6 |
| **最大** | 1,955 | 3,906 | 3,309 | 1,423 |
| **95パーセンタイル** | 690 | 810 | 400 | 390 |
| **99パーセンタイル** | 1,100 | 2,200 | 1,800 | 620 |

*50ユーザーテストは中断

#### 応答時間劣化
- **中央値:** 44ms → 50ms → 61msと一貫した劣化（38.6%の総増加）
- **95パーセンタイル:** 30→40ユーザーで改善（810ms → 400ms） - テスト中断の影響の可能性
- **最大レイテンシ:** 30ユーザーでピーク（3,906ms）、システムストレスを示唆

### 3. 操作別性能

#### カート作成操作

| 指標 | 20ユーザー | 30ユーザー | 40ユーザー | 50ユーザー* |
|--------|----------|----------|----------|-----------|
| **中央値 (ms)** | 150 | 230 | 320 | 440 |
| **平均 (ms)** | 171.9 | 367.9 | 327.1 | 432.5 |
| **95% (ms)** | 350 | 1,100 | 470 | 650 |
| **最大 (ms)** | 578 | 1,816 | 1,084 | 875 |
| **リクエスト数** | 157 | 125 | 45 | 50 |

**分析:**
- 中央値応答時間が**193.3%増加**（150ms → 440ms）
- リクエスト数が**71.3%減少**（成功したテストで157 → 45完了カート）
- 30ユーザーで顕著なレイテンシスパイク（最大1,816ms）

#### アイテム登録操作

| 指標 | 20ユーザー | 30ユーザー | 40ユーザー | 50ユーザー* |
|--------|----------|----------|----------|-----------|
| **中央値 (ms)** | 42 | 47 | 59 | 61 |
| **平均 (ms)** | 83.8 | 107.8 | 88.0 | 87.8 |
| **標準偏差 (ms)** | 96.1 | 184.2 | 116.1 | 96.1 |
| **CV (%)** | 114.7% | 170.9% | 131.9% | 109.4% |
| **95% (ms)** | 200 | 350 | 250 | 220 |
| **最大 (ms)** | 1,688 | 2,937 | 1,046 | 547 |
| **リクエスト数** | 2,934 | 2,244 | 859 | 950 |

**分析:**
- 最も安定した操作で、中央値の増加は**45.2%**（42ms → 61ms）
- 最も高頻度の操作（全リクエストの85%以上）
- リクエスト数が**70.7%減少**（完了テストで2,934 → 859）
- **高い変動性:** CV値が109.4%～170.9%、応答時間の不一致を示す
- **30ユーザーで最悪の変動性:** CV 170.9%、標準偏差184.2msはシステムストレスを示唆
- **50ユーザーで一貫性改善:** CVが109.4%に減少（ただしテストは中断）

#### カートキャンセル操作

| 指標 | 20ユーザー | 30ユーザー | 40ユーザー | 50ユーザー* |
|--------|----------|----------|----------|-----------|
| **中央値 (ms)** | 760 | 980 | 1,900 | 1,200 |
| **平均 (ms)** | 816.1 | 1,291.4 | 1,905.8 | 1,180.4 |
| **95% (ms)** | 1,200 | 2,800 | 3,300 | 1,400 |
| **最大 (ms)** | 1,955 | 3,906 | 3,309 | 1,423 |
| **リクエスト数** | 138 | 101 | 16 | 7 |

**分析:**
- 全パターンで**最も遅い操作**
- 中央値応答時間が**150.0%増加**（760ms → 1,900ms）
- **深刻なリクエスト数減少:** 91.3%減少（138 → 16 → 7）
- 最も高いレイテンシの操作、ピークで**3.9秒**に到達

---

## 統計的変動性分析

### アイテム登録操作 - 応答時間の一貫性

| パターン | 平均 (ms) | 標準偏差 (ms) | CV (%) | 評価 |
|---------|--------------|--------------|--------|----------------|
| 20ユーザー | 83.8 | 96.1 | 114.7% | 高い変動性 |
| 30ユーザー | 107.8 | 184.2 | 170.9% | 非常に高い変動性 |
| 40ユーザー | 88.0 | 116.1 | 131.9% | 高い変動性 |
| 50ユーザー* | 87.8 | 96.1 | 109.4% | 高い変動性 |

*50ユーザーテストは中断

**注:** 標準偏差はp95-p50の関係を使用してパーセンタイル分布から推定されています。

### 変動係数（CV）分析

**CV評価ガイドライン:**
- **CV < 15%:** 優れた一貫性
- **CV 15-30%:** 良好な一貫性
- **CV 30-50%:** 中程度の変動性
- **CV 50-100%:** 高い変動性
- **CV > 100%:** 非常に高い変動性

**主要な発見:**

1. **全パターンで非常に高い変動性（CV > 100%）**
   - これは応答時間が非常に予測不可能であることを示す
   - ユーザーは一貫性のない性能を経験する可能性
   - システムはリソース競合またはキューイングを経験している可能性

2. **30ユーザーで変動性のピーク（CV = 170.9%）**
   - 標準偏差（184.2ms）が平均（107.8ms）の**1.7倍**
   - 応答時間範囲: 34ms（最小）～2,937ms（最大）= **86倍の差**
   - この負荷レベルでシステムが不安定状態に入ることを示唆

3. **40～50ユーザーで改善傾向**
   - CVが170.9% → 131.9% → 109.4%と減少
   - ただし、これはテスト中断と標本サイズの減少による可能性
   - 絶対リクエスト数が劇的に減少（2,244 → 859 → 950）

4. **50ユーザーで最良の一貫性（109.4%）**
   - 全パターン中で最低のCV、ただし依然として非常に高い
   - 早期終了のアーティファクトの可能性（20ユーザーの2,934リクエストに対し950リクエストのみ）
   - 最大応答時間も最低（30ユーザーの2,937msに対し547ms）

### 変動性劣化パターン

| 遷移 | CV変化 | 評価 |
|------------|-----------|----------------|
| 20 → 30ユーザー | +56.2ポイント (114.7% → 170.9%) | 顕著な劣化 |
| 30 → 40ユーザー | -39.0ポイント (170.9% → 131.9%) | 改善（負荷減少の可能性） |
| 40 → 50ユーザー | -22.5ポイント (131.9% → 109.4%) | 改善（テスト中断） |

**分析:**
30～50ユーザーでのCVの改善は直感に反し、以下を示す可能性があります:
1. 失敗したリクエストまたはタイムアウトによる実効負荷の減少
2. サバイバーバイアス（クラッシュ前に最も速いリクエストのみが完了）
3. 完全な障害前にシステムが負荷を排除

### 応答時間分布特性

**歪度分析（パーセンタイルから）:**

| パターン | p50 (ms) | p95 (ms) | p95/p50 比率 | 歪度 |
|---------|----------|----------|---------------|----------|
| 20ユーザー | 42 | 200 | 4.76倍 | 高い右歪 |
| 30ユーザー | 47 | 350 | 7.45倍 | 非常に高い右歪 |
| 40ユーザー | 59 | 250 | 4.24倍 | 高い右歪 |
| 50ユーザー* | 61 | 220 | 3.61倍 | 中程度の右歪 |

**解釈:**
- 全ての分布が**右歪の**応答時間を示す（ロングテール）
- ほとんどのリクエストは迅速に完了（42～61ms中央値）
- 小さな割合のリクエストが深刻な遅延を経験（p95で200～350ms）
- 時折のリソース競合、ロック待機、またはGCポーズを示唆

---

## 特定された重大な問題

### 1. 50ユーザーでサービス到達不能

**症状:**
- 50ユーザー負荷テスト中にカートサービスがUNREACHABLEになった
- 完了前にテストが中断
- 総リクエスト数が1,007のみ（期待される約3,000+に対し）

**証拠:**
- 統計履歴が成功したテストの597行に対し377行のみを示す
- リクエスト数が著しく少ない: 他のテストの125～157に対し50カート作成
- 完了したキャンセル操作が7のみ（他のテストの16～138に対し）

**根本原因分析が必要:**
- メモリ枯渇の可能性
- コネクションプール飽和
- データベース接続制限
- スレッド/非同期タスクプール枯渇
- Fire-and-forgetロギングでのリソース競合

### 2. 40ユーザーでのスループット異常

**観察:**
- 40ユーザーテストが30ユーザーテスト（4.12）より**高いRPS**（7.30）を示す
- テストが早期終了したか、異なる実行時条件があった可能性を示唆

**考えられる原因:**
- テスト期間の変動
- 早期終了
- テスト間のサービス再起動
- キャッシュ効果

### 3. キャンセル操作の性能劣化

**問題:**
- カートキャンセル操作が**深刻な性能劣化**を示す
- 応答時間が他の操作の3～5倍遅い
- 負荷下で数量が劇的に減少

**影響:**
- キャンセル操作でユーザーエクスペリエンスが著しく劣化
- 本番環境でのタイムアウト問題の可能性
- データベースロック競合または非効率的なトランザクションロールバックを示す可能性

---

## 性能劣化サマリー

### ユーザー負荷別（20 → 40ユーザー）

| 指標 | 変化 | 影響 |
|--------|--------|--------|
| 中央値応答時間 | +38.6% (44ms → 61ms) | 中程度 |
| カート作成中央値 | +113.3% (150ms → 320ms) | 高 |
| アイテム登録中央値 | +40.5% (42ms → 59ms) | 中程度 |
| カートキャンセル中央値 | +150.0% (760ms → 1,900ms) | 重大 |
| 総リクエスト数 | -71.5% (3,229 → 920) | 重大 |

### 応答時間分布

| パーセンタイル | 20ユーザー | 30ユーザー | 40ユーザー | 劣化 |
|------------|----------|----------|----------|-------------|
| 50% (中央値) | 44ms | 50ms | 61ms | +38.6% |
| 75% | 82ms | 100ms | 99ms | +20.7% |
| 90% | 210ms | 360ms | 250ms | +19.0% |
| 95% | 690ms | 810ms | 400ms | -42.0%* |
| 99% | 1,100ms | 2,200ms | 1,800ms | +63.6% |

*負の劣化は早期テスト終了による可能性が高い

---

## 以前の結果との比較

### Fire-and-Forgetロギング（現在の実装）

**FIRE_AND_FORGET_LOGGING_PERFORMANCE_REPORT.mdから:**
- 20ユーザー: 4.51 req/s、97ms中央値
- 現在の20ユーザー: 5.39 req/s、44ms中央値

**改善:**
- スループット+19.5%増加
- 応答時間+54.6%改善

**分析:**
これは、最近の最適化がベースライン性能を改善したことを示唆していますが、スケーリング特性は依然として問題があります。

---

## 推奨事項

### 即座のアクション（優先度1）

1. **50ユーザーでのサービスクラッシュの調査**
   - メモリ/リソース枯渇のためのカートサービスログをレビュー
   - ヒープ使用量、GCアクティビティ、コネクションプールを監視
   - 特定の障害ポイントを特定（OOM、接続タイムアウトなど）
   - asyncioタスクキューオーバーフローをチェック

2. **高い応答時間変動性への対処（CV > 100%）**
   - **根本原因:** 114～171%のCVは深刻な性能予測不可能性を示す
   - **影響:** ユーザーは10～100倍の応答時間変動を経験（42msから2,937ms）
   - **アクション:**
     - レイテンシスパイクのソースをプロファイルし特定
     - 非同期コード内のブロッキングI/O操作をチェック
     - ガベージコレクションポーズをレビュー
     - ロック競合とキュー蓄積を監視
     - リクエストタイムアウト強制を追加（外れ値を防ぐ）

3. **カートキャンセル操作の最適化**
   - キャンセル操作実行パスをプロファイル
   - データベーストランザクション処理をレビュー
   - 悲観的ロックではなく楽観的ロックを検討
   - ロック競合の監視を追加
   - 現在の性能: 最大3.9秒のレイテンシは許容不可

4. **リソース制限分析**
   - MongoDBコネクションプール設定をレビュー
   - 非同期タスク制限を検証（uvicornワーカー、非同期プールサイズ）
   - Redisコネクションプーリングをチェック
   - Fire-and-forgetキュー深度制限をレビュー
   - asyncioイベントループ遅延を監視

### 短期的な改善（優先度2）

5. **コネクションプールのチューニング**
   - 同時ユーザー目標に基づいたMongoDBコネクションプールサイジングを実装
   - コネクションプール監視とアラートを追加
   - 読み取り/書き込み操作用の別々のプールを検討

6. **負荷削減 / レート制限**
   - 50ユーザー閾値前にリクエストレート制限を実装
   - キャンセル操作にサーキットブレーカーパターンを追加
   - グレースフルデグラデーション戦略

7. **非同期タスク管理**
   - Fire-and-forgetタスクキュー実装をレビュー
   - キューオーバーフローを防ぐバックプレッシャーメカニズムを追加
   - 保留中のタスク数を監視
   - 無制限の成長を防ぐタスクキュー深度制限を実装

### 長期的な最適化（優先度3）

8. **水平スケーリング調査**
   - ロードバランサーを使用したマルチインスタンスデプロイメントをテスト
   - インスタンス間のセッション/状態管理を検証
   - インスタンスごとの容量制限を測定

9. **データベース最適化**
   - カートコレクションのインデックスをレビュー
   - レポートクエリ用のリードレプリカを検討
   - マルチテナントスケーリング用のシャーディング戦略を評価

10. **アーキテクチャレビュー**
    - 非同期リクエストロギングキューアーキテクチャを評価
    - Fire-and-forget操作にメッセージキュー（RabbitMQ/Kafka）を検討
    - ロギング操作のリクエスト合体を実装
    - 潜在的なブロッキング操作のasync/awaitパターンをレビュー

---

## テスト環境詳細

### テスト構成
- **テストツール:** Locust
- **テスト期間:** パターンごとに10分
- **ランプアップ:** 即座（開始時に全ユーザーを生成）
- **テストシナリオ:** カート作成 → アイテム追加 → カートキャンセル ワークフロー

### システム構成
- **サービス:** カートサービス（ポート8003）
- **データベース:** レプリカセット付きMongoDB
- **キャッシング:** Redis
- **アーキテクチャ:** async/await付きFastAPI
- **ロギング:** Fire-and-forget非同期実装

---

## 結論

1. **現在の容量:** システムは**40同時接続ユーザー**まで確実にサポート
2. **障害閾値:** **40～50ユーザー**間でサービスが不安定化
3. **スケーリング係数:** 20→40ユーザーで約71%のリクエスト数減少は、劣悪なスケーリング特性を示す
4. **クリティカルパス:** カートキャンセル操作が主要な性能ボトルネック（最大3.9秒のレイテンシ）
5. **安定性:** 成功したテストでのゼロ失敗リクエストは、容量制限内での良好なエラーハンドリングを実証
6. **性能予測不可能性:** 非常に高いCV（109～171%）は、深刻な応答時間不一致を示す
   - ユーザーは2～86倍の応答時間変動を経験する可能性
   - 30同時接続ユーザーで変動性のピークが発生
   - システムは負荷下でリソース競合またはキューイング遅延を示す

### 性能品質評価

| 側面 | 評価 | 証拠 |
|--------|--------|----------|
| **スループット** | ⚠️ 不良 | 20→40ユーザーで71%劣化 |
| **レイテンシ（中央値）** | ⚠️ 中程度 | 45%増加（42ms → 61ms） |
| **一貫性** | ❌ 重大 | CV > 100% = 非常に高い変動性 |
| **信頼性** | ✅ 良好 | 容量内で0%の失敗 |
| **スケーラビリティ** | ❌ 重大 | 50ユーザーでサービスクラッシュ |

### 次のステップ

1. **即座:** 正確な障害閾値を特定するための45ユーザーテストを実行
2. **即座:** 50ユーザーテスト中のカートサービスログをクラッシュ分析のためにレビュー
3. **即座:** 高い応答時間変動性（CV > 100%）をプロファイルし修正
4. **短期:** リソース使用率、CV、パーセンタイルレイテンシのための監視ダッシュボードを実装
5. **中期:** カートキャンセル操作を最適化（現在のボトルネック）
6. **長期:** 100+同時接続ユーザーを目標とした容量改善を計画
7. **長期:** より良い水平スケーラビリティのためのアーキテクチャ変更を検討

---

## 付録: 生テストデータ

### テストファイルの場所
```
results_backup/20251021_030417/
├── 20users/
│   ├── Custom_20users_20251021_030558_stats.csv
│   ├── Custom_20users_20251021_030558_stats_history.csv
│   └── Custom_20users_20251021_030558.html
├── 30users/
│   ├── Custom_30users_20251021_031819_stats.csv
│   ├── Custom_30users_20251021_031819_stats_history.csv
│   └── Custom_30users_20251021_031819.html
├── 40users/
│   ├── Custom_40users_20251021_033041_stats.csv
│   ├── Custom_40users_20251021_033041_stats_history.csv
│   └── Custom_40users_20251021_033041.html
└── 50users/ (中断)
    ├── Custom_50users_20251021_034305_stats.csv
    ├── Custom_50users_20251021_034305_stats_history.csv
    └── Custom_50users_20251021_034305.html
```

### パターン別リクエスト分布

| パターン | カート作成 | アイテム追加 | カートキャンセル | 合計 |
|---------|-------------|----------|-------------|-------|
| 20ユーザー | 157 (4.9%) | 2,934 (90.9%) | 138 (4.3%) | 3,229 |
| 30ユーザー | 125 (5.1%) | 2,244 (90.9%) | 101 (4.1%) | 2,470 |
| 40ユーザー | 45 (4.9%) | 859 (93.4%) | 16 (1.7%) | 920 |
| 50ユーザー* | 50 (5.0%) | 950 (94.4%) | 7 (0.7%) | 1,007 |

*中断されたテスト

---

**レポート生成日:** 2025-10-21
**分析者:** Claude Code
**バージョン:** 1.0
