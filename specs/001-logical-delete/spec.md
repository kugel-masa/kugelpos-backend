# 機能仕様: 商品カテゴリマスターの論理削除

**Feature Branch**: `001-logical-delete`
**Created**: 2025-12-08
**Status**: Draft
**Input**: 商品カテゴリマスターに論理削除機能を追加。現在は物理削除（データベースから完全削除）だが、これを論理削除（is_deletedフラグで管理）に変更する。

## Clarifications

### Session 2025-12-08

- Q: 削除済みカテゴリを特定カテゴリコード取得APIで取得しようとした場合、どのようなエラー応答を返すべきか？ → A: 404 Not Foundエラーを返す（削除済みカテゴリは「存在しない」として扱う）
- Q: 削除されていないカテゴリを復元しようとした場合、どのようなエラー応答を返すべきか？ → A: 400 Bad Requestエラーを返す（削除されていないカテゴリを復元するのは不正なリクエスト）
- Q: 削除済みカテゴリを更新しようとした場合、どのようなエラー応答を返すべきか？ → A: 400 Bad Requestエラーを返す（削除済みカテゴリの更新は不正なリクエスト）
- Q: 削除済みカテゴリと同じcategory_codeで新規作成しようとした場合、どのようなエラー応答を返すべきか？ → A: 409 Conflictエラーを返す（削除済みカテゴリと新規作成リクエストが競合している）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - カテゴリの論理削除 (Priority: P1)

システム管理者が商品カテゴリを削除する際、データベースから完全に削除するのではなく、削除フラグを立てて論理的に削除状態にする。これにより、過去のトランザクションデータとの整合性を保ちながら、現在は使用していないカテゴリを非表示にできる。

**Why this priority**: カテゴリは過去のトランザクションで参照されているため、物理削除すると履歴データの整合性が失われる。論理削除は最も基本的で重要な機能。

**Independent Test**: カテゴリ削除APIを呼び出し、カテゴリが削除フラグ付きで保存されていること、および通常の取得APIでは表示されないことを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 有効なカテゴリが存在する, **When** システム管理者がカテゴリ削除APIを実行する, **Then** カテゴリのis_deletedフラグがtrueに設定され、deleted_atに削除日時が記録される
2. **Given** 削除済みカテゴリが存在する, **When** 全カテゴリ取得APIを実行する（削除済みを含まない）, **Then** 削除済みカテゴリは結果に含まれない
3. **Given** 削除済みカテゴリが存在する, **When** 特定カテゴリコードで取得APIを実行する, **Then** 404 Not Foundエラーが返される（削除済みカテゴリは存在しないものとして扱う）

---

### User Story 2 - 削除済みカテゴリの取得 (Priority: P2)

システム管理者が削除済みを含むすべてのカテゴリを確認したい場合や、監査目的で削除済みカテゴリの情報を参照したい場合に対応する。削除済みカテゴリも含めて取得できるオプションを提供する。

**Why this priority**: 通常運用では不要だが、監査・トラブルシューティング・データ分析時には必要となる機能。

**Independent Test**: include_deleted=trueパラメータを指定してAPIを呼び出し、削除済みカテゴリも含まれることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 削除済みカテゴリが存在する, **When** include_deleted=trueで全カテゴリ取得APIを実行する, **Then** 削除済みカテゴリも含めてすべてのカテゴリが返される
2. **Given** 削除済みカテゴリが存在する, **When** include_deleted=trueで特定カテゴリコード取得APIを実行する, **Then** 削除済みカテゴリも取得できる

---

### User Story 3 - 削除済みカテゴリの復元 (Priority: P3)

誤って削除したカテゴリや、再度使用したいカテゴリを復元できる機能。is_deletedフラグをfalseに戻し、deleted_atをクリアすることで復元する。

**Why this priority**: あれば便利だが、必須ではない。カテゴリの再作成でも代替可能。ただし、同じカテゴリコードを維持したい場合には有用。

**Independent Test**: 削除済みカテゴリに対して復元APIを呼び出し、is_deletedがfalseになり、通常の取得APIで表示されることを確認することで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 削除済みカテゴリが存在する, **When** カテゴリ復元APIを実行する, **Then** is_deletedがfalseに設定され、deleted_atがクリアされる
2. **Given** 復元されたカテゴリが存在する, **When** 全カテゴリ取得APIを実行する, **Then** 復元されたカテゴリが結果に含まれる
3. **Given** 削除されていない（有効な）カテゴリが存在する, **When** カテゴリ復元APIを実行する, **Then** 400 Bad Requestエラーが返される（カテゴリは既に有効な状態であることを示すメッセージを含む）

---

### Edge Cases

- 既に削除済みのカテゴリを再度削除しようとした場合、成功応答を返す（冪等性の確保）
- 削除されていないカテゴリを復元しようとした場合、400 Bad Requestエラーを返す（不正なリクエスト）
- 削除済みカテゴリと同じcategory_codeで新規作成しようとした場合、409 Conflictエラーを返す（削除済みカテゴリとの競合）
- カテゴリ更新時に削除済みカテゴリを更新しようとした場合、400 Bad Requestエラーを返す（削除済みカテゴリは更新不可）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: CategoryMasterDocumentにis_deletedフィールド（boolean型、デフォルトFalse）を追加する
- **FR-002**: CategoryMasterDocumentにdeleted_atフィールド（datetime型、オプショナル）を追加する
- **FR-003**: カテゴリ削除時、データベースから物理削除せず、is_deletedをTrue、deleted_atに削除日時を設定する
- **FR-004**: カテゴリ取得API（全件・単一）は、デフォルトでis_deleted=Falseのカテゴリのみを返す
- **FR-005**: カテゴリ取得APIにinclude_deletedパラメータを追加し、trueの場合は削除済みカテゴリも含めて返す
- **FR-006**: カテゴリ更新APIは、is_deleted=Trueのカテゴリに対しては400 Bad Requestエラーを返す（削除済みカテゴリは更新不可）
- **FR-007**: カテゴリ復元用のAPIエンドポイントを追加し、is_deletedをFalse、deleted_atをNullに設定する
- **FR-008**: 既に削除済みのカテゴリを再度削除しても、エラーにせず正常応答を返す（冪等性の確保）
- **FR-009**: 既存のデータベースレコードに対して、is_deletedとdeleted_atフィールドのデフォルト値を設定するマイグレーションを提供する
- **FR-010**: 削除済みカテゴリと同じcategory_codeで新規作成しようとした場合、409 Conflictエラーを返す（削除済みカテゴリとの競合を示すメッセージを含む）
- **FR-011**: 削除済みカテゴリを特定カテゴリコード取得APIで取得しようとした場合、404 Not Foundエラーを返す（include_deleted=falseまたは未指定の場合）
- **FR-012**: 削除されていないカテゴリを復元しようとした場合、400 Bad Requestエラーを返す（現在の状態を示すエラーメッセージを含む）

### Key Entities

- **CategoryMasterDocument**: 商品カテゴリを表すドキュメントクラス
  - 追加属性: `is_deleted` (boolean, デフォルトFalse), `deleted_at` (datetime, オプショナル)
  - 既存属性: `tenant_id`, `category_code`, `description`, `description_short`, `tax_code`

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: カテゴリ削除後も、過去のトランザクションデータからカテゴリ情報を参照できる（データ整合性の維持）
- **SC-002**: 削除済みカテゴリは通常のカテゴリ一覧に表示されず、システムの利用者が混乱しない
- **SC-003**: 監査担当者が削除済みカテゴリを含むすべてのカテゴリ履歴を確認できる
- **SC-004**: 誤削除時に1分以内にカテゴリを復元できる
- **SC-005**: 既存のカテゴリデータに対してマイグレーションが正常に完了し、is_deletedフィールドが全レコードに追加される

## Assumptions *(optional)*

- カテゴリは master-data サービスで管理されている
- カテゴリ削除機能は既に存在し、現在は物理削除を行っている
- カテゴリコード（category_code）は tenant_id と組み合わせて一意である
- 削除済みカテゴリも一意制約の対象となる（同じcategory_codeで新規作成できない）
- 復元機能は管理者権限を持つユーザーのみが利用できる（既存の認証・認可の仕組みを使用）
- 論理削除への移行は後方互換性を保つ（既存のAPIエンドポイントは維持）

## Out of Scope *(optional)*

- 削除済みカテゴリの物理削除（アーカイブ）機能
- 削除済みカテゴリの完全削除を一定期間後に自動実行する機能
- カテゴリ削除履歴の詳細なログ記録（誰が・いつ削除したかは deleted_at で記録）
- UI側での削除済みカテゴリの表示・フィルタリング機能（APIのみを提供）
- 他のマスターデータ（商品、支払い方法など）への論理削除機能の適用
